#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# AÑO: 2026 CREADOR: Ramírez León Christian Yael

import glob
import json
import os
import socket
import subprocess
import sys


def get_socket_path():
    sig = os.getenv("HYPRLAND_INSTANCE_SIGNATURE")
    xdg = os.getenv("XDG_RUNTIME_DIR")

    candidates = []

    if sig:
        candidates.append(f"/tmp/hypr/{sig}/.socket2.sock")
        if xdg:
            candidates.append(f"{xdg}/hypr/{sig}/.socket2.sock")

    candidates += glob.glob("/tmp/hypr/*/.socket2.sock")
    if xdg:
        candidates += glob.glob(f"{xdg}/hypr/*/.socket2.sock")

    for path in candidates:
        if os.path.exists(path):
            return path

    return None


def print_workspaces():
    try:
        result = subprocess.run(
            ["hyprctl", "workspaces", "-j"], capture_output=True, text=True
        )
        data = json.loads(result.stdout)

        data.sort(key=lambda x: x["id"])

        names = [ws["name"] for ws in data]

        print(" ".join(names))
        sys.stdout.flush()
    except Exception as e:
        pass


# --- INICIO ---
socket_path = get_socket_path()

if not socket_path:
    print("Error: Socket no encontrado")
    sys.exit(1)

print_workspaces()

try:
    with socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) as client:
        client.connect(socket_path)

        while True:
            data = client.recv(1024).decode("utf-8", errors="ignore")
            if not data:
                break

            if any(
                x in data
                for x in [
                    "workspace>>",
                    "createworkspace>>",
                    "destroyworkspace>>",
                    "moveworkspace>>",
                ]
            ):
                print_workspaces()

except KeyboardInterrupt:
    sys.exit(0)
except Exception as e:
    print(f"Error de conexión: {e}")
    sys.exit(1)

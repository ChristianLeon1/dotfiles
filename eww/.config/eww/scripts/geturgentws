#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# AÑO: 2026 CREADOR: Ramírez León Christian Yael

import socket
import os
import subprocess
import sys
import json
import glob

# Diccionario para recordar ventanas urgentes: { "dirección_hex": "nombre_workspace" }
urgent_windows = {}

def get_socket_path():
    # Misma lógica robusta que el script anterior
    sig = os.getenv("HYPRLAND_INSTANCE_SIGNATURE")
    xdg = os.getenv("XDG_RUNTIME_DIR")
    candidates = []
    if sig:
        candidates.append(f"/tmp/hypr/{sig}/.socket2.sock")
        if xdg:
            candidates.append(f"{xdg}/hypr/{sig}/.socket2.sock")
    candidates += glob.glob("/tmp/hypr/*/.socket2.sock")
    if xdg:
        candidates += glob.glob(f"{xdg}/hypr/*/.socket2.sock")
    for path in candidates:
        if os.path.exists(path):
            return path
    return None

def get_workspace_of_client(addr):
    """Busca en qué workspace está una ventana específica dado su ID (address)"""
    try:
        # Consultamos todos los clientes
        result = subprocess.run(["hyprctl", "clients", "-j"], capture_output=True, text=True)
        clients = json.loads(result.stdout)
        
        # Buscamos la ventana que coincida con la dirección (address)
        # Nota: Hyprland a veces usa "0x" y a veces no en el socket, normalizamos.
        addr_clean = addr.lower()
        if not addr_clean.startswith("0x"):
            addr_clean = "0x" + addr_clean

        for client in clients:
            client_addr = client['address'].lower()
            if client_addr == addr_clean:
                return client['workspace']['name']
    except:
        pass
    return None

def print_urgent():
    """Imprime los workspaces únicos que tienen ventanas urgentes"""
    # Obtenemos solo los nombres de los workspaces, eliminamos duplicados y ordenamos
    unique_workspaces = sorted(list(set(urgent_windows.values())))
    print(" ".join(unique_workspaces))
    sys.stdout.flush()

# --- INICIO ---

socket_path = get_socket_path()
if not socket_path:
    sys.exit(1)

# Estado inicial vacío (Hyprland no nos dice quién es urgente al inicio)
print_urgent()

try:
    with socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) as client:
        client.connect(socket_path)
        
        while True:
            data = client.recv(1024).decode('utf-8', errors='ignore')
            if not data:
                break
            
            lines = data.split('\n')
            for line in lines:
                # EVENTO 1: Una ventana pide atención (se pone roja)
                if line.startswith("urgent>>"):
                    addr = line.split(">>")[1]
                    ws_name = get_workspace_of_client(addr)
                    if ws_name:
                        urgent_windows[addr] = ws_name
                        print_urgent()

                # EVENTO 2: Enfocamos una ventana (la urgencia debería borrarse)
                elif line.startswith("activewindowv2>>"):
                    addr = line.split(">>")[1]
                    # Si la ventana que acabamos de tocar estaba marcada como urgente, la borramos
                    # (Normalizamos direcciones por si acaso)
                    keys_to_remove = []
                    for u_addr in urgent_windows:
                        # Comparamos sin el "0x" para evitar problemas de formato
                        if u_addr.endswith(addr) or addr.endswith(u_addr):
                            keys_to_remove.append(u_addr)
                    
                    if keys_to_remove:
                        for k in keys_to_remove:
                            del urgent_windows[k]
                        print_urgent()

                # EVENTO 3: Una ventana se mueve de workspace
                elif line.startswith("movewindow>>"):
                    parts = line.split(">>")[1].split(",")
                    if len(parts) >= 2:
                        addr = parts[0]
                        ws_dest = parts[1]
                        # Si la ventana movida era urgente, actualizamos su workspace
                        for u_addr in urgent_windows:
                             if u_addr.endswith(addr) or addr.endswith(u_addr):
                                urgent_windows[u_addr] = ws_dest
                                print_urgent()

except KeyboardInterrupt:
    sys.exit(0)
except Exception:
    sys.exit(1)
